name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        # CMAKE is already installed on GitHub runners
        echo "Using system cmake: $(cmake --version)"

    - name: Build EFEFTE
      run: |
        # Build everything in one step to avoid path issues
        make clean
        make build plugin

    - name: Run tests
      run: |
        ./build/efefte

    - name: Package Audio Unit
      run: |
        cd build
        if [ -d "EFEFTEAudioUnit.component" ]; then
          zip -r EFEFTE-AudioUnit-${{ github.sha }}.zip EFEFTEAudioUnit.component
        else
          echo "Audio Unit not found, skipping..."
        fi

    - name: Package Standalone App
      run: |
        cd build
        if [ -d "EFEFTEStandalone.app" ]; then
          zip -r EFEFTE-Standalone-${{ github.sha }}.zip EFEFTEStandalone.app
        else
          echo "Standalone app not found, skipping..."
        fi

    - name: Upload Audio Unit Artifact
      uses: actions/upload-artifact@v4
      with:
        name: efefte-audiounit
        path: build/EFEFTE-AudioUnit-${{ github.sha }}.zip

    - name: Upload Standalone Artifact
      uses: actions/upload-artifact@v4
      with:
        name: efefte-standalone
        path: build/EFEFTE-Standalone-${{ github.sha }}.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/EFEFTE-AudioUnit-${{ github.sha }}.zip
          build/EFEFTE-Standalone-${{ github.sha }}.zip
        body: |
          ## EFEFTE Release ${{ github.ref_name }}

          ðŸŽµ **Audio Unit Plugin for Logic Pro**
          - Real-time FFT spectrum analysis
          - Professional audio processing tools
          - Native macOS integration

          ðŸ’» **Standalone Spectrum Analyser**
          - Independent microphone analysis
          - Development and testing tool
          - No Logic Pro required

          ### Installation

          **Audio Unit:**
          1. Download `EFEFTE-AudioUnit-*.zip`
          2. Unzip and copy `EFEFTEAudioUnit.component` to `~/Library/Audio/Plug-Ins/Components/`
          3. Restart Logic Pro

          **Standalone:**
          1. Download `EFEFTE-Standalone-*.zip`
          2. Unzip and run `EFEFTEStandalone.app`

          Built with EFEFTE FFT Library v${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    # Add environment for GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Add permissions for GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4